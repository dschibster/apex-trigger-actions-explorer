<template>
    <div class="slds-card">
        <div class="slds-card__header slds-card__header_toggle">
            <div class="slds-grid slds-grid_align-spread">
                <div class="slds-media slds-media_center" onclick={handleToggle} style="cursor: pointer;">
                    <lightning-icon icon-name={chevronIcon} size="small" class={chevronClass}></lightning-icon>
                    <h3 class="slds-text-heading_medium">{title}</h3>
                </div>
                <div class="slds-no-flex">
                    <template if:false={isEditOrderMode}>
                        <lightning-button 
                            variant="neutral" 
                            label="Add Action" 
                            icon-name="utility:add"
                            size="small"
                            onclick={handleAddAction}
                            class="slds-m-right_small">
                        </lightning-button>
                        <lightning-button 
                            variant="neutral" 
                            label="Edit Order" 
                            icon-name="utility:sort"
                            size="small"
                            onclick={handleEditOrder}
                            class="slds-m-right_small">
                        </lightning-button>
                    </template>
                    <template if:true={isEditOrderMode}>
                        <div class="slds-grid slds-grid_align-center">
                            <span class="slds-text-body_small slds-m-right_x-small">Manual:</span>
                            <lightning-input 
                                type="toggle" 
                                checked={isManualEditMode}
                                onchange={handleToggleManualMode}
                                class="slds-m-right_small">
                            </lightning-input>
                            <lightning-button 
                                variant="brand" 
                                label="Save Order" 
                                icon-name="utility:check"
                                size="small"
                                onclick={handleSaveOrder}
                                class="slds-m-right_small">
                            </lightning-button>
                            <lightning-button 
                                variant="neutral" 
                                label="Cancel" 
                                icon-name="utility:close"
                                size="small"
                                onclick={handleCancelOrder}>
                            </lightning-button>
                        </div>
                    </template>
                    <slot name="actions"></slot>
                </div>
            </div>
        </div>
        <template if:true={isExpanded}>
            <div class="slds-p-horizontal_none slds-is-relative">
                <!-- Section Update Spinner -->
                <template if:true={isThisSectionUpdating}>
                    <div class="slds-is-relative slds-p-around_large">
                        <lightning-spinner alternative-text="Updating order..." size="small"></lightning-spinner>
                        <div class="slds-text-align_center slds-m-top_small">
                            <p class="slds-text-body_small slds-text-color_weak">Updating {title} order...</p>
                        </div>
                    </div>
                </template>
                
                <!-- Section Content -->
                <template if:false={isThisSectionUpdating}>
                    <template if:true={actions}>
                        <div class="slds-list slds-has-dividers_top">
                            <template for:each={actions} for:item="act" for:index="index">
                                <c-trigger-action-card 
                                    key={act.Id} 
                                    action={act}
                                    visual-order={index}
                                    is-edit-order-mode={isEditOrderMode}
                                    is-manual-edit-mode={isManualEditMode}
                                    is-first-item={act.isFirstItem}
                                    is-last-item={act.isLastItem}
                                    onview={handleView}
                                    onedit={handleEdit}
                                    ondelete={handleDelete}
                                    onmoveaction={handleMoveAction}
                                    onmanualorderchange={handleManualOrderChange}
                                    onmanualorderblur={handleManualOrderBlur}>
                                </c-trigger-action-card>
                            </template>
                        </div>
                    </template>
                    <template if:false={actions}>
                        <div class="slds-text-align_center slds-p-around_large">
                            <lightning-icon icon-name="utility:info" size="small" class="slds-m-bottom_small"></lightning-icon>
                            <p class="slds-text-color_weak slds-text-body_regular">No actions found</p>
                            <p class="slds-text-color_weak slds-text-body_small slds-m-top_x-small">Click "Add Action" to create your first trigger action</p>
                        </div>
                    </template>
                </template>
            </div>
        </template>
    </div>
</template>