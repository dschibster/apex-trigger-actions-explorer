<template>
    <!-- Builder Header Section -->
    <div class="slds-builder-header_container">
        <header class="slds-builder-header">
            <div class="slds-builder-header__item">
                <lightning-icon variant="inverse" size="small" icon-name="utility:topic"></lightning-icon>
                <div class="slds-builder-header__item-label slds-media slds-media_center">
                    <h1 class="slds-media__body">Trigger Actions Explorer</h1>
                </div>
            </div>
        </header>
    </div>

    <!-- White Background Container -->
    <div class="white-background-container">
        <!-- Loading Spinner -->
        <template if:true={isLoading}>
            <div class="slds-is-relative slds-p-around_large">
                <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
            </div>
        </template>


        <!-- Error Display -->
        <template if:true={error}>
            <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error" role="alert">
                <span class="slds-assistive-text">error</span>
                <lightning-icon icon-name="utility:error" alternative-text="Error" size="small"></lightning-icon>
                <h2>{error}</h2>
            </div>
        </template>

        <!-- Main Content (only show when not loading and no errors) -->
        <template if:false={isLoading}>
            <template if:false={error}>
                <!-- Centered Context Text with Dropdowns -->
                <div class="slds-p-around_large slds-border_bottom slds-is-relative">
                    <!-- Action Buttons (floating right) -->
                    <div class="slds-float_right">
                        <div class="slds-button-group" role="group">
                            <lightning-button-icon
                                variant="neutral" 
                                icon-name="utility:refresh" 
                                title="Refresh Data"
                                onclick={handleRefresh}
                                disabled={isLoading}
                                class="slds-m-right_x-small">
                            </lightning-button-icon>
                            <lightning-button-icon
                                variant="neutral" 
                                icon-name="utility:edit" 
                                title="Edit SObject Trigger Setting"
                                onclick={handleEditSetting}
                                disabled={isEditSettingDisabled}
                                class="slds-m-right_x-small">
                            </lightning-button-icon>
                            <lightning-button-icon
                                variant="neutral" 
                                icon-name="utility:add" 
                                title="Add New SObject Trigger Setting"
                                onclick={handleAddSetting}>
                            </lightning-button-icon>
                        </div>
                    </div>
                    
                    <!-- Centered Content -->
                    <div class="slds-text-align_center">
                        <div class="slds-text-heading_medium slds-text-color_weak">
                            <lightning-combobox
                                name="timing"
                                value={selectedTiming}
                                placeholder="Select timing..."
                                options={timingOptionsList}
                                onchange={handleTimingChange}
                                variant="label-hidden"
                                class="inline-dropdown">
                            </lightning-combobox>
                            {articleText} 
                            <lightning-combobox
                                name="triggerSetting"
                                value={selectedSetting}
                                placeholder="Select SObject..."
                                options={triggerSettingsOptions}
                                onchange={handleSettingChange}
                                variant="label-hidden"
                                class="inline-dropdown slds-size_1-of-5">
                            </lightning-combobox>
                            is 
                            <lightning-combobox
                                name="context"
                                value={selectedContext}
                                placeholder="Select action..."
                                options={contextOptions}
                                onchange={handleContextChange}
                                variant="label-hidden"
                                class="inline-dropdown">
                            </lightning-combobox>
                            <!-- Badges after all picklists -->
                            <template if:true={selectedSetting}>
                                <span class="slds-m-left_x-small">
                                    <lightning-badge 
                                        label={selectedSettingBadgeLabel} 
                                        variant={selectedSettingBadgeVariant}>
                                    </lightning-badge>
                                </span>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="slds-p-around_medium content-container">
                    <template if:true={selectedSetting}>
                        <template if:true={selectedContext}>
                            <template if:true={selectedTiming}>
                                <template if:true={showSections}>
                                    <!-- Before Section -->
                                    <template if:true={shouldShowBeforeActions}>
                                        <div class="slds-m-bottom_large">
                                            <c-trigger-actions-section 
                                                title="Before Actions" 
                                                actions={beforeActions} 
                                                is-updating={isUpdating}
                                                updating-section={updatingSection}
                                                onview={handleViewAction}
                                                onedit={handleEditAction} 
                                                onaddaction={handleAddAction}
                                                onentereditmode={handleEnterEditMode}
                                                onsaveorder={handleSaveOrder}>
                                            </c-trigger-actions-section>
                                        </div>
                                    </template>
                                    <!-- After Section -->
                                    <template if:true={shouldShowAfterActions}>
                                        <div class="slds-m-bottom_large">
                                            <c-trigger-actions-section 
                                                title="After Actions" 
                                                actions={afterActions} 
                                                is-updating={isUpdating}
                                                updating-section={updatingSection}
                                                onview={handleViewAction}
                                                onedit={handleEditAction} 
                                                onaddaction={handleAddAction}
                                                onentereditmode={handleEnterEditMode}
                                                onsaveorder={handleSaveOrder}>
                                            </c-trigger-actions-section>
                                        </div>
                                    </template>
                                </template>
                            </template>
                            <template if:false={selectedTiming}>
                                <div class="slds-text-align_center slds-p-around_large">
                                    <p class="slds-text-color_weak">Please select timing, trigger setting, and context to view actions</p>
                                </div>
                            </template>
                        </template>
                        <template if:false={selectedContext}>
                            <div class="slds-text-align_center slds-p-around_large">
                                <p class="slds-text-color_weak">Please select both a trigger setting and context to view actions</p>
                            </div>
                        </template>
                    </template>
                    <template if:false={selectedSetting}>
                        <div class="slds-text-align_center slds-p-around_large">
                            <p class="slds-text-color_weak">Please select a trigger setting to begin</p>
                        </div>
                    </template>
                </div>
            </template>
        </template>
    </div>
    
    <!-- Trigger Action Modal -->
    <c-trigger-action-modal 
        is-open={isModalOpen}
        action={selectedAction}
        mode={modalMode}
        is-updating={isUpdating}
        section-context={sectionContext}
        trigger-context={selectedContext}
        selected-setting-id={selectedSetting}
        selected-setting-developer-name={selectedSettingDeveloperName}
        selected-setting-object-api-name={selectedSettingName}
        existing-developer-names={developerNameCache}
        onclose={handleModalClose}
        onmodechange={handleModalModeChange}
        onupdate={handleModalUpdate}>
    </c-trigger-action-modal>

    <!-- Trigger Setting Modal -->
    <c-trigger-setting-modal 
        is-open={isSettingModalOpen}
        setting={selectedSettingData}
        mode={settingModalMode}
        is-updating={isUpdating}
        onclose={handleSettingModalClose}
        onmodechange={handleSettingModalModeChange}
        onupdate={handleSettingModalUpdate}>
    </c-trigger-setting-modal>

</template>
